<!DOCTYPE html>
<html> 
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>ASCIICAM</title>
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
	<style type="text/css">
	div{
		font-size: 8px;
	}
	h1{
		font-size: 48px;
		font-family: monospace;
		font-weight: bold;
		text-align: center;
	}
	video{
		display: none;
	}
	#wrap{
		width: 640px;
		margin: auto;
		text-align: center;
	}

	</style>
</head>
<body>
	<div id="wrap">
		<h1>IM IN UR WEBCAM CONVERTING UR PIXELS!</h1>
			<video width="640" height="480" id="cam" autoplay></video>
			<div style="width: 640px; height: 480px;" id="ascii"></div>
			<input type="button" value="Toggle" id="toggle">
		</div>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script type="text/javascript">

		$(function(){

		function hasGetUserMedia() {
		// Note: Opera is unprefixed.
  		return !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
		}

		if (!hasGetUserMedia()) {
			alert('Sorry, but getUserMedia() is not supported in your browser');
		} else {
			navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
		}

		navigator.getUserMedia({video: true, audio: true}, function(localMediaStream) {
	
			var video = document.querySelector('#cam');

			window.URL = (window.URL || window.webkitURL);

			video.src = window.URL.createObjectURL(localMediaStream);

			// Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
			// See crbug.com/110938.
			asciicam();

		}, function(){

			alert('Something went wrong!!')
		
		});

		function asciicam(){
		
					//SETUP
					var
					letters = 'MXI/-.'.split(''),
					colors = [],
					$ascii = $('#ascii'),
					cam = $('#cam')[0],
					dimensions = {
						
						width: $(cam).width(),
						height: $(cam).height()
						
					};

					for (var a = 0; a < letters.length; a++){

						colors.push({

							top: 255 / letters.length * (a + 1),
							bottom: 255 / letters.length * a,
							letter: letters[a]
							
						});

					};

					var dummy = $('<span>').text('a').css({'font-family' : 'monospace', 'visibility' : 'hidden'}).appendTo($(cam).parent());
					
					var charSize = {
						x : 5,
						y : 8
					};

					dummy.remove();
					
					var blocks = {

						x : ~~(dimensions.width / charSize.x),
						y : ~~(dimensions.height / charSize.y)

					},
					playing = false;
					pic = $('<canvas>').attr(dimensions).hide(),
					picCtx = pic[0].getContext('2d');
					$('body').append(pic);

					picCtx.translate(dimensions.width, 0);
					picCtx.scale(-1, 1);

					$ascii.css('line-height', '8px');

					var drawVideoOnCanvas;
					
					$('#toggle').click(function(){

						if (!playing){

							playing = true;

							drawVideoOnCanvas = setInterval(function(){

								
								picCtx.drawImage(cam, 0, 0, dimensions.width, dimensions.height);
								var d = picCtx.getImageData(0, 0, dimensions.width, dimensions.height).data;
								$ascii.html(cpaToString(d));

							}, 1000 / 25);
						
						} else {
						
							clearInterval(drawVideoOnCanvas);
							playing = false;
					
						}

					}).click();

					
					function cpaToString(cpa){

						var reducedPixelArray = [];

						//get rid of alpha and reduce RGB to a single average value
						for (var b = 0, c = cpa.length; b < c; b += 4){
							reducedPixelArray.push(Math.max(cpa[b],cpa[b + 1],cpa[b + 2]));
						}

						//this will contain one luminance value for each letter-block
						var blockArray = [];

						for (var h = 0; h < blocks.y; h++){ //move along y at block level

							for (var i = 0; i < blocks.x; i++){ //move along x at block level

								var pixelsInBlock = [];
								var baseOffset = h * charSize.y * dimensions.width + i * charSize.x;

								for (var j = 0; j < charSize.y; j++){ //move along y at pixel level

									for (var k = 0; k < charSize.x; k++){ //move along x at pixel level
										
										var currentOffset = baseOffset + (j * dimensions.width + k);
										pixelsInBlock.push(reducedPixelArray[currentOffset]);

									}

								}

								//average all pixels in the current block and push into blockArray
								blockArray.push(~~(pixelsInBlock.reduce(function(a,b){return a + b;}) / (charSize.x * charSize.y)));

							}

						}

						var letters = [];

						for (var l = 0; l < blocks.y; l++){

							for (var m = 0; m < blocks.x; m++){

								$.each(colors, function(){

									if (blockArray[0] <= this.top && blockArray[0] >= this.bottom){

										letters.push(this.letter);
										return false;

									}

								});

								blockArray.shift();

							}

							letters.push('\n'); //append line break

						}

						//Array.join() is much faster than String += in IEs
						return '<pre>' + letters.join('') + '</pre>';

					}
				
				}


				});


</script>

</body>
</html>